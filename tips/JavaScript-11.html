<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <link rel="shortcut icon" href="https://iwasakishuto.github.io/images/apple-touch-icon/front-end.png" />
        <title>JS.11 TensorFlow.jsでMNIST</title>
        <link rel="stylesheet" href="https://iwasakishuto.github.io/front-end/tips/theme/css/main.css" />
        <!-- Use fontawesome Icon -->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
        <!-- Syntax highlight -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/github.min.css">
        <!-- Custom CSS -->
        <link rel="stylesheet" type="text/css" href="https://iwasakishuto.github.io/css/custom.css" media="screen">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <!-- LaTex -->
        <!-- Github env -->
        <!--<script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
        <script type="text/x-mathjax-config">
        	MathJax.Hub.Config({
        		tex2jax: {
        			inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        			displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
        		}
        	});
        </script>
        <!-- Mermaid -->
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js" charset="UTF-8"></script>
        <script>
          mermaid.initialize({
            startOnLoad:true
          });
        </script>

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://iwasakishuto.github.io/front-end/tips/">Front-End </a></h1>
                <nav><ul>
                    <li class="active"><a href="https://iwasakishuto.github.io/front-end/tips/category/javascript.html">JavaScript</a></li>
                </ul>
<form id="search" action"#" onsubmit="javascript:window.open('https://duckduckgo.com/?q='+document.getElementById('keywords').value+'+site:https://iwasakishuto.github.io/front-end/tips');">
                        <input id="keywords" type="text" />
                    </form>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://iwasakishuto.github.io/front-end/tips/JavaScript-11.html" rel="bookmark"
           title="Permalink to JS.11 TensorFlow.jsでMNIST">JS.11 TensorFlow.jsでMNIST</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>2019-06-14(金)</span>
<span>| tags: <a href="https://iwasakishuto.github.io/front-end/tips/tag/javascript.html">JavaScript</a></span>
</footer><!-- /.post-info -->      <h1>JS.11 TensorFlow.jsでMNIST</h1>
<p>機械学習のチュートリアルでおなじみMNISTを<code>TensorFlow.js</code>でやってみました。</p>
<p>下のキャンバスに0~9の数字を書いて、<code>predict</code> ボタンを押してみてください！！</p>
<h3>作ったもの</h3>
<div class="mnist">
  <div class="drawing">
    <canvas id="drawing-pad" width="280" height="280" style="border: 2px solid;"></canvas>
    <canvas id="hidden-pad" style="display: none;"></canvas><br/>
    <button id="predict-button" class="predict" onclick="prediction()">
      <i id="loading" class="fa fa-spinner fa-spin" style="disabled: false;"></i>
    </button>
    <button id="reset-button" class="reset" onclick="reset()">
      reset
    </button>
  </div>
  <div class="result">
    <table>
      <thead>
        <tr>
          <th>Number</th>
          <th>Accuracy</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>0</th>
          <td class="accuracy" data-row-index="0">-</td>
        </tr>
        <tr>
          <th>1</th>
          <td class="accuracy" data-row-index="1">-</td>
        </tr>
        <tr>
          <th>2</th>
          <td class="accuracy" data-row-index="2">-</td>
        </tr>
        <tr>
          <th>3</th>
          <td class="accuracy" data-row-index="3">-</td>
        </tr>
        <tr>
          <th>4</th>
          <td class="accuracy" data-row-index="4">-</td>
        </tr>
        <tr>
          <th>5</th>
          <td class="accuracy" data-row-index="5">-</td>
        </tr>
        <tr>
          <th>6</th>
          <td class="accuracy" data-row-index="6">-</td>
        </tr>
        <tr>
          <th>7</th>
          <td class="accuracy" data-row-index="7">-</td>
        </tr>
        <tr>
          <th>8</th>
          <td class="accuracy" data-row-index="8">-</td>
        </tr>
        <tr>
          <th>9</th>
          <td class="accuracy" data-row-index="9">-</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<style>
  .mnist {
    padding: 10px;
    width: 100%;
    overflow: hidden;
  }
  .drawing {
    float: left;
    width: 50%;
    text-align: center;
  }
  .result {
    float: right;
    width: 50%;
  }
  .predict{
    padding: 10px;
    background-color: #80160e;
  }
  .reset {
    padding: 10px;
    background-color: #c8c8a0;
  }
  .is-selected {
    background-color: #80160e;
    color: white;
  }
  @media only screen and (max-width: 1200px) {
    .drawing {
      width: 100%;
      text-align: center;
    }
    .result {
      width: 100%;
    }
  }
  @media only screen and (max-width: 760px) {
    .drawing {
      float: left;
      width: 50%;
      text-align: center;
    }
    .result {
      float: right;
      width: 50%;
    }
  }
  @media only screen and (max-width: 640px) {
    .drawing {
      width: 100%;
      text-align: center;
    }
    .result {
      width: 100%;
    }
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.8.0"></script>

<script src="https://docs.opencv.org/3.4/opencv.js" type="text/javascript"></script>

<script>
  // init SignaturePad
  const drawElement = document.getElementById('drawing-pad');
  const signaturePad = new SignaturePad(drawElement, {
    minWidth: 6,
    maxWidth: 6,
    penColor: 'white',
    backgroundColor: 'black',
  });
  // load pre-trained model
  let model;
  const model_path = '../../js/TensorFlowJs/MNIST/tf-model/model.json'
  tf.loadModel(model_path)
    .then(function(pretrainedModel){
      model = pretrainedModel;
      document.getElementById('predict-button').innerHTML = "predict";
      document.getElementById('loading').style.disabled="true";
    });
  function getImageData() {
    // grayscale
    const src = cv.imread(drawElement);
    let dst_gray = new cv.Mat();
    cv.cvtColor(src, dst_gray, cv.COLOR_RGBA2GRAY, 0);
    // resize
    let dst_resized = new cv.Mat();
    let dsize = new cv.Size(28, 28);
    cv.resize(dst_gray, dst_resized, dsize, 0, 0, cv.INTER_AREA);
    cv.imshow('hidden-pad', dst_resized);
    const imageData = document.getElementById('hidden-pad').getContext('2d').getImageData(0, 0, 28, 28);
    src.delete();
    dst_gray.delete();
    dst_resized.delete();
    return imageData;
  }
  function getAccuracyScores(imageData) {
    // メモリリークの心配がなくなる。自動的にメモリを解放。
    const score = tf.tidy(function () {
      const channels = 1;
      let input = tf.fromPixels(imageData, channels);
      input = tf.cast(input, 'float32').div(tf.scalar(255));
      input = input.expandDims();
      return model.predict(input).dataSync();
    });
    return score;
  }
  function prediction() {
    const imageData = getImageData();
    const accuracyScores = getAccuracyScores(imageData);
    const maxAccuracy = accuracyScores.indexOf(Math.max.apply(null, accuracyScores));
    const elements = document.querySelectorAll(".accuracy");
    elements.forEach(function (el){
      el.parentNode.classList.remove('is-selected');
      const rowIndex = Number(el.dataset.rowIndex);
      if (maxAccuracy === rowIndex) {
        el.parentNode.classList.add('is-selected');
      }
      el.innerText = accuracyScores[rowIndex];
    })
  }
  function reset() {
    signaturePad.clear();
    let elements = document.querySelectorAll(".accuracy");
    elements.forEach(function (el){
      el.parentNode.classList.remove('is-selected');
      el.innerText = '-';
    })
  }
</script>

<hr>
<p>なお、訓練は<a href="https://keras.io/examples/mnist_cnn/">Mnist cnn - Keras Documentation</a>に従って行なっていますが、一応モデルの重みを<code>TensorFlow.js</code>の形式に変換するところまでを含めて<a href="https://github.com/iwasakishuto/iwasakishuto.github.io/blob/master/js/TensorFlowJs/MNIST/Training.ipynb">notebook</a>にまとめてあります。</p>
<p>また、<code>TensorFlow.js</code>に関しては、<a href="https://github.com/iwasakishuto/iwasakishuto.github.io/tree/master/js/TensorFlowJs">README.md</a>に簡単にまとめてあります。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="https://iwasakishuto.github.io">Home</a></li>
                            <li><a href="https://iwasakishuto.github.io/blog/articles/index.html">Blog</a></li>
                            <li><a href="https://iwasakishuto.github.io/University/index.html">University</a></li>
                            <li><a href="https://iwasakishuto.github.io/Kerasy/doc/index.html">Kerasy</a></li>
                            <li><a href="https://iwasakishuto.github.io/front-end/tips/index.html">Front-End</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><i class="fab fa-twitter sidebar-social-links"></i><a href="https://twitter.com/cabernet_rock">twitter</a></li>
                            <li><i class="fab fa-github sidebar-social-links"></i><a href="https://github.com/iwasakishuto">github</a></li>
                            <li><i class="fab fa-facebook sidebar-social-links"></i><a href="https://www.facebook.com/iwasakishuto">facebook</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>